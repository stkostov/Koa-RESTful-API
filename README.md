# 📚 Koa RESTful API with Knex and PostgreSQL

A simple and lightweight backend API built with **Koa**, using **Knex** for database queries and **PostgreSQL** for persistent storage.  
It demonstrates JWT-based authentication, data validation with Zod, and a DAO-based architecture.

---

## ⚙️ Implementation

- Using **Koa** for a lightweight, fast backend
- Using **koa-bodyparser** for handling requests and responses
- Using **koa-logger** for better logging
- Authenticating users with **JWT tokens** handled by the `koa-jwt` library
- Assigning JWT tokens using the **jsonwebtoken** library
- Using **Router** to organize multiple API endpoints
- Keeping sensitive information inside a **.env** file
- Using **Zod** to validate incoming data
- **PostgreSQL** database manages the relationship between **Users** and **Books**

---

## 🔄 Workflow

- A user can **sign up** with an account containing their `username`, `email`, and `password` *(still not hashed)*  
  - If the user already exists → an error is thrown  
  - If the user is new → an account is created and a **JWT token** is assigned, valid for **7 hours**
- A user can **sign in** with their credentials
- Other functionalities require a **valid JWT token** to access:
  - User CRUD operations  
  - Books CRUD operations  
  - User–Books relation CRUD operations

---

## 🧍 Sign Up Operation

- On sign up, the user must create an account with:
  - A valid email (following standard email format)
  - A username
  - A password longer than 6 characters

---

## 🔐 Sign In Operation

- Signing in is done via **email** and **password** credentials.

---

## 👤 User CRUD Operations

### ➕ Create
- **Route:** `POST /users`
- **Description:** Creates a new user.
- **Body Example:**
  ```json
  {
    "email": "user@example.com",
    "username": "JohnDoe",
    "password": "password123"
  }
  ```
- **Notes:**
  - The user's `id` is automatically generated by the database.

---

### 🔍 Read
- **Get All Users**
  - **Route:** `GET /users`
  - **Description:** Retrieves all users present in the database.

- **Get User by ID**
  - **Route:** `GET /users/:id`
  - **Description:** Retrieves a specific user by their ID.

- **Get User’s Books**
  - **Route:** `GET /user-books/:id`
  - **Description:** Retrieves all books associated with a specific user.

---

### ✏️ Update
- **Route:** `PUT /users/:id`
- **Description:** Updates user information.
- **Notes:**
  - You can update one or more fields: `username`, `email`, or `password`.
  - Empty updates or adding extra properties is not allowed.

---

### ❌ Delete
- **Route:** `DELETE /users/:id`
- **Description:** Deletes a user by ID.

---

## 📚 Book CRUD Operations

### ➕ Create
- **Route:** `POST /books`
- **Description:** Creates a new book.
- **Body Example:**
  ```json
  {
    "name": "The Great Gatsby",
    "author": "F. Scott Fitzgerald",
    "date": "1925-04-10"
  }
  ```
- **Notes:**
  - The book’s `id` is automatically generated by the database.

---

### 🔍 Read
- **Get All Books**
  - **Route:** `GET /books`
  - **Description:** Retrieves all books in the database.

- **Get Book by ID**
  - **Route:** `GET /books/:id`
  - **Description:** Retrieves a specific book by ID.

---

### ✏️ Update
- **Route:** `PUT /books/:id`
- **Description:** Updates book information.
- **Notes:**
  - You can update `name`, `author`, or `date`.
  - Empty updates or additional fields are not permitted.

---

### ❌ Delete
- **Route:** `DELETE /books/:id`
- **Description:** Deletes a book by ID.

---

## 🔗 User ↔️ Book Relations

### ➕ Create
- **Route:** `POST /user/:userId/book/:bookId`
- **Description:** Creates a relation between a user and a book.
- **Notes:**
  - Both `userId` and `bookId` must exist in the database.

---

### ✏️ Update
- **Description:** Allows changing the user associated with a specific book.

---

### ❌ Delete
- **Route:** `DELETE /user/:userId/book/:bookId`
- **Description:** Removes the relation between a user and a book.

---

## 🧠 DAOs (Data Access Objects)
- Used to handle data operations.
- Lightweight alternative to repositories — simpler for testing and maintaining.
- Each DAO follows a standard CRUD interface.

---

## 🧪 Testing

- **Framework:** Jest  
- **Coverage Goal:** 80% (statements, branches, functions, and lines)
- **Database Dependency:** None (DAO mocks are used)
- **Key Points:**
  - DAOs are mocked to eliminate the need for a real database.
  - `any` types are avoided by using strong TypeScript interfaces.
  - Responses are validated against fake mocked data.

---

## 🧩 Interfaces

- **Purpose:** Ensure strong typing across DAOs, routers, and tests.
- **Base Interface:** `CRUDInterface` — defines core CRUD methods.
- **Extensions:** Used to cover additional custom methods when needed.

---

## 🚀 Running the Project

### 🔧 Setup Commands (in order)
1. `docker compose build`  
2. `docker compose up`  
3. `npm run migrate`  
4. `npm run seed`

---

### 🧭 Testing & Postman
- Import the **Postman collection JSON** from the `postman/collections/` to test all routes once the containers are up.
- Run tests:
  ```
  npm run test
  ```
- Check coverage:
  ```
  npm run test-coverage
  ```

---

💡 **Tip:** Ensure Docker is running before executing the commands.

